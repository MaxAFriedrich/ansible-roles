---
- name: Get the latest dotenvage version
  uri:
    url: https://api.github.com/repos/dataroadinc/dotenvage/releases/latest
    return_content: yes
  register: github_release
  when: dotenvage_version is not defined

- name: Set dotenvage version
  set_fact:
    dotenvage_version: "{{ dotenvage_version | default(github_release.json.tag_name) }}"

- name: Set build paths
  set_fact:
    dotenvage_repo_url: "https://github.com/dataroadinc/dotenvage.git"
    dotenvage_src_dir: "/tmp/dotenvage-src"

- name: Remove previous workspace
  file:
    path: "{{ dotenvage_src_dir }}"
    state: absent

- name: Checkout dotenvage source
  git:
    repo: "{{ dotenvage_repo_url }}"
    dest: "{{ dotenvage_src_dir }}"
    version: "{{ dotenvage_version }}"
    depth: 1
    force: true

- name: Build static dotenvage binary inside Docker
  command: >
    docker run --rm
    -v {{ dotenvage_src_dir }}:/source
    -w /source
    ghcr.io/messense/rust-musl-cross:x86_64-musl
    sh -c "rustup target add x86_64-unknown-linux-musl && cargo build --target x86_64-unknown-linux-musl --release"
  environment:
    CARGO_TERM_COLOR: never
  register: build_dotenvage
  changed_when: build_dotenvage.rc == 0

- name: Install dotenvage binary
  copy:
    src: "{{ dotenvage_src_dir }}/target/x86_64-unknown-linux-musl/release/dotenvage"
    dest: /usr/local/bin/dotenvage
    owner: root
    group: root
    mode: '0755'
    remote_src: yes
